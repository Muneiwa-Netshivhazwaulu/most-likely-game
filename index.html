<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Who's Most Likely</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #0b0f19;
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
    }
    .card {
      background: #111827;
      padding: 2rem;
      border-radius: 16px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 0 30px rgba(59,130,246,0.25);
      text-align: center;
    }
    h1 { color: #60a5fa; }
    input, button {
      width: 100%;
      padding: 0.8rem;
      margin-top: 1rem;
      border-radius: 10px;
      border: none;
      font-size: 1rem;
    }
    input { background: #020617; color: #e5e7eb; border: 1px solid #1e293b; }
    button {
      background: #3b82f6;
      color: white;
      font-weight: 600;
      cursor: pointer;
    }
    button:hover { background: #2563eb; }
    .hidden { display: none; }
    .options button { margin-top: 0.7rem; }
  </style>
</head>
<body>

<div class="card" id="login">
  <h1>Who's Most Likely</h1>
  <p>Enter your name and room password</p>
  <input id="name" placeholder="Your name" />
  <input id="room" placeholder="Room password" />
  <button onclick="joinRoom()">Join Game</button>
</div>

<div class="card hidden" id="game">
  <button id="resetBtn" class="hidden" onclick="resetGame()">ðŸ”„ New Game (Host)</button>
  <h1 id="question">Who's most likely toâ€¦</h1>
  <div class="options" id="options"></div>
  <button id="nextBtn" class="hidden" onclick="nextQuestion()">Next Question (Host)</button>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCCsGJ90tOfI_falyoe3yPV9SJ1Ic8ByHs",
    authDomain: "most-likely-114bc.firebaseapp.com",
    databaseURL: "https://most-likely-114bc-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "most-likely-114bc",
    storageBucket: "most-likely-114bc.firebasestorage.app",
    messagingSenderId: "3398254312",
    appId: "1:3398254312:web:d7a0496e4e76221072535d"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const QUESTIONS = [
    "forget their own birthday",
    "be late to their own wedding",
    "spend all their money in one day",
    "become famous",
    "fall asleep in class",
    "start a business",
    "get arrested",
    "travel the world",
    "fail a driving test",
    "ghost someone"
  ];

  let username = "";
  let room = "";
  let isHost = false;
  let sessionId = null;
  let myPlayerKey = null;

  window.joinRoom = async () => {
    alert("Join Game clicked");

    username = document.getElementById('name').value.trim();
    room = document.getElementById('room').value.trim();

    if (!username || !room) {
      alert('Fill in both fields');
      return;
    }

    document.getElementById('login').classList.add('hidden');
    document.getElementById('game').classList.remove('hidden');

    const roomRef = db.ref(`rooms/${room}`);
    const snapshot = await roomRef.get();

    if (!snapshot.exists()) {
      isHost = true;
      sessionId = Date.now();
      roomRef.set({
        sessionId,
        host: null,{
        sessionId,
        question: "Who's most likely to " + QUESTIONS[Math.floor(Math.random() * QUESTIONS.length)],
        players: {},
        votes: {},
        scores: {}
      });
      document.getElementById('nextBtn').classList.remove('hidden');
      document.getElementById('resetBtn').classList.remove('hidden');
    } else {
      sessionId = snapshot.val().sessionId;
    }

    const newPlayerRef = roomRef.child('players').push(username);
    myPlayerKey = newPlayerRef.key;
    roomRef.child('scores/' + username).set(0);

    window.addEventListener('beforeunload', () => {
      if (myPlayerKey) {
        roomRef.child('players/' + myPlayerKey).remove();
        roomRef.child('scores/' + username).remove();
      }
    });
    roomRef.child('scores/' + username).set(0);
    listenForGame();
  };

  const listenForGame = () => {
    const roomRef = db.ref(`rooms/${room}`);

    roomRef.on('value', snapshot => {
      const data = snapshot.val();
      if (!data) return;

      document.getElementById('question').innerText = data.question;
      const optionsDiv = document.getElementById('options');
      optionsDiv.innerHTML = "";

      if (data.players) {
        Object.entries(data.players).forEach(([key, player]) => {(player => {
          const btn = document.createElement('button');
          btn.innerText = player;
          btn.onclick = () => vote(player);
          optionsDiv.appendChild(btn);
        });

        // Host reassignment if current host left
        if (!data.host && Object.keys(data.players).length > 0) {
          const firstKey = Object.keys(data.players)[0];
          db.ref(`rooms/${room}/host`).set(firstKey);
        }

        if (data.host === myPlayerKey) {
          isHost = true;
          document.getElementById('nextBtn').classList.remove('hidden');
          document.getElementById('resetBtn').classList.remove('hidden');
        } else {
          isHost = false;
          document.getElementById('nextBtn').classList.add('hidden');
          document.getElementById('resetBtn').classList.add('hidden');
          optionsDiv.appendChild(btn);
        });
      }

      if (data.votes) {
        const tally = {};
        Object.values(data.votes).forEach(choice => {
          tally[choice] = (tally[choice] || 0) + 1;
        });

        let winner = null;
        let maxVotes = 0;
        for (const name in tally) {
          if (tally[name] > maxVotes) {
            maxVotes = tally[name];
            winner = name;
          }
        }

        if (winner) {
          document.getElementById('question').innerText = `ðŸ† ${winner} wins this round!`;
          if (data.scores && data.scores[winner] !== undefined) {
            db.ref(`rooms/${room}/scores/${winner}`).set(data.scores[winner] + 1);
          }
        }
      }
    });
  };

  window.nextQuestion = () => {
    const q = "Who's most likely to " + QUESTIONS[Math.floor(Math.random() * QUESTIONS.length)];
    db.ref(`rooms/${room}/question`).set(q);
    db.ref(`rooms/${room}/votes`).set({});
  };

  window.resetGame = () => {
    if (!isHost) return;
    const newSession = Date.now();
    db.ref(`rooms/${room}`).set({
      sessionId: newSession,
      question: "Who's most likely to " + QUESTIONS[Math.floor(Math.random() * QUESTIONS.length)],
      players: {},
      votes: {},
      scores: {}
    });
  };

  const vote = async (choice) => {
    const voteRef = db.ref(`rooms/${room}/votes/${username}`);
    const snap = await voteRef.get();
    if (snap.exists()) {
      alert("You already voted this round");
      return;
    }
    voteRef.set(choice);
    alert(`You voted for ${choice}`);
  };
</script>

</body>
</html>
